# Generated by Django 5.0.2 on 2025-06-13 12:09

import stdimage.models
from django.db import migrations


def render_image_variations(apps, schema_editor):
    """
    Re-renders all variations for StdImageFields for Result and UniversityLogo.
    This is a data migration to process existing images.
    """
    Result = apps.get_model('app', 'Result')
    UniversityLogo = apps.get_model('app', 'UniversityLogo')

    # Using print because self.stdout is not available in migrations.
    # Using iterator() for memory efficiency.
    print('\nProcessing Result images for migration...')
    for obj in Result.objects.iterator():
        if obj.image:
            try:
                obj.image.render_variations(replace=True)
            except Exception as e:
                print(f"Could not process image for Result {obj.pk}: {e}")
    print('Successfully processed Result images.')

    print('Processing UniversityLogo images for migration...')
    for obj in UniversityLogo.objects.iterator():
        if obj.logo:
            try:
                obj.logo.render_variations(replace=True)
            except Exception as e:
                print(f"Could not process logo for UniversityLogo {obj.pk}: {e}")
    print('Successfully processed UniversityLogo images.')


class Migration(migrations.Migration):

    dependencies = [
        ("app", "0048_alter_result_image_alter_universitylogo_logo"),
    ]

    operations = [
        migrations.AlterField(
            model_name="result",
            name="image",
            field=stdimage.models.StdImageField(
                force_min_size=False,
                upload_to="results/",
                variations={"large": (1200, 800), "thumbnail": (512, 512, True)},
                verbose_name="Image",
            ),
        ),
        migrations.AlterField(
            model_name="universitylogo",
            name="logo",
            field=stdimage.models.StdImageField(
                force_min_size=False,
                upload_to="universities/logos/",
                variations={"thumbnail": (512, 512)},
                verbose_name="Logo",
            ),
        ),
        migrations.RunPython(render_image_variations, migrations.RunPython.noop),
    ]
