{% load i18n admin_urls static admin_modify %}
<div class="js-inline-admin-formset inline-group" id="{{ inline_admin_formset.formset.prefix }}-group"
     data-inline-type="tabular"
     data-inline-formset="{{ inline_admin_formset.inline_formset_data }}">
  <div class="tabular inline-related {% if forloop.last %}last-related{% endif %}">
    {{ inline_admin_formset.formset.management_form }}
    <fieldset class="module {{ inline_admin_formset.classes }}">
      {% if inline_admin_formset.formset.max_num == 1 %}
        <h2>{{ inline_admin_formset.opts.verbose_name|capfirst }}</h2>
      {% else %}
        <h2>{{ inline_admin_formset.opts.verbose_name_plural|capfirst }}</h2>
      {% endif %}
      {{ inline_admin_formset.formset.non_form_errors }}
      <table class="table">
        <thead>
          <tr>
            <th class="original" style="width: 40px;"></th>
            {% for field in inline_admin_formset.fields %}
              <th class="column-{{ field.name }}{% if field.required %} required{% endif %}{% if field.widget.is_hidden %} hidden{% endif %}">
                {{ field.label|capfirst }}
                {% if field.help_text %}
                  <i class="fas fa-question-circle text-info" data-toggle="tooltip" title="{{ field.help_text|striptags }}"></i>
                {% endif %}
              </th>
            {% endfor %}
            {% if inline_admin_formset.formset.can_delete and inline_admin_formset.has_delete_permission %}
              <th style="width: 60px;">{% translate "Delete?" %}</th>
            {% endif %}
          </tr>
        </thead>

        <tbody class="sortable">
          {% for inline_admin_form in inline_admin_formset %}
            {% if inline_admin_form.form.non_field_errors %}
              <tr class="row-form-errors">
                <td colspan="{{ inline_admin_form|cell_count }}">
                  {{ inline_admin_form.form.non_field_errors }}
                </td>
              </tr>
            {% endif %}
            <tr class="form-row {% if inline_admin_form.original or inline_admin_form.show_url %}has_original{% endif %}{% if forloop.last and inline_admin_formset.has_add_permission %} empty-form{% endif %} dynamic-{{ inline_admin_formset.formset.prefix }}"
                 id="{{ inline_admin_formset.formset.prefix }}-{% if forloop.last and inline_admin_formset.has_add_permission %}empty{% else %}{{ forloop.counter0 }}{% endif %}">
              <td class="original text-center drag-handler" style="cursor: move;">
                {% if inline_admin_form.needs_explicit_pk_field %}{{ inline_admin_form.pk_field.field }}{% endif %}
                {% if inline_admin_form.fk_field %}{{ inline_admin_form.fk_field.field }}{% endif %}
                <i class="fas fa-grip-vertical text-muted"></i>
              </td>
              {% for fieldset in inline_admin_form %}
                {% for line in fieldset %}
                  {% for field in line %}
                    <td class="{% if field.field.name %}field-{{ field.field.name }}{% endif %}{% if field.field.is_hidden %} hidden{% endif %}">
                      {% if field.is_readonly %}
                        <p>{{ field.contents }}</p>
                      {% else %}
                        {{ field.field.errors.as_ul }}
                        {{ field.field }}
                      {% endif %}
                    </td>
                  {% endfor %}
                {% endfor %}
              {% endfor %}
              {% if inline_admin_formset.formset.can_delete and inline_admin_formset.has_delete_permission %}
                <td class="delete text-center">
                  {% if inline_admin_form.original %}
                    {{ inline_admin_form.deletion_field.field }}
                  {% endif %}
                </td>
              {% endif %}
            </tr>
          {% endfor %}
        </tbody>
      </table>
      {% if inline_admin_formset.formset.can_add %}
        <div class="add-row mt-3">
          <a href="#" class="btn btn-sm btn-success">
            <i class="fas fa-plus"></i> {% blocktranslate with verbose_name=inline_admin_formset.opts.verbose_name %}Add another {{ verbose_name }}{% endblocktranslate %}
          </a>
        </div>
      {% endif %}
    </fieldset>
  </div>
</div>

<style>
  .sortable .original {
    white-space: nowrap;
    padding: 8px !important;
  }
  .drag-handler {
    font-size: 14px;
  }
  .drag-handler:hover {
    color: #333;
  }
  .ui-sortable-helper {
    display: table;
    background: white;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  }
  .ui-sortable-placeholder {
    visibility: visible !important;
    background: #f8f9fa;
    border: 1px dashed #dee2e6;
  }
  .table td {
    vertical-align: middle;
  }
</style>

<script>
  django.jQuery(function($) {
    $('.sortable').sortable({
      handle: '.drag-handler',
      axis: 'y',
      placeholder: 'ui-sortable-placeholder',
      forcePlaceholderSize: true,
      helper: function(e, tr) {
        var $originals = tr.children();
        var $helper = tr.clone();
        $helper.children().each(function(index) {
          $(this).width($originals.eq(index).width());
        });
        return $helper;
      },
      update: function(event, ui) {
        $('._reorder_').each(function(i) {
          $(this).val(i + 1);
        });
      }
    }).disableSelection();
    
    $('[data-toggle="tooltip"]').tooltip();

    $('.delete input[type="checkbox"]').addClass('form-check-input');
  });
</script>